@model StudentManagement.Models.Employee
@{
    ViewData["Title"] = "Create Employee";
}

<div class="container-fluid" style="font-size: 0.8rem;">
    <div class="row">
        <div class="col-lg-4 col-md-5 col-sm-12">
            <h5 class="text-center mb-1">Create Employee</h5>
            <div class="card p-1 mb-1 border-0" style="max-height: 600px; overflow-y: auto;">
                <form asp-action="Create" method="post" enctype="multipart/form-data">
                    <div class="row g-1">
                        <div class="col-12 mb-1">
                            <label for="Name" class="form-label mb-0">Name</label>
                            <input type="text" class="form-control form-control-sm py-1" id="Name" name="Name" value="@(Model?.Name ?? "")" required />
                        </div>
                        <div class="col-12 mb-1">
                            <div class="row g-1 align-items-center">
                                <div class="col-md-6 col-sm-12">
                                    <label class="form-label mb-0">Sex</label><br />
                                    <div class="form-check form-check-inline">
                                        <input type="radio" class="form-check-input" id="Male" name="Sex" value="Male" @(Model?.Sex == "Male" ? "checked" : "") required />
                                        <label for="Male" class="form-check-label">Male</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input type="radio" class="form-check-input" id="Female" name="Sex" value="Female" @(Model?.Sex == "Female" ? "checked" : "") required />
                                        <label for="Female" class="form-check-label">Female</label>
                                    </div>
                                </div>

                                <div class="col-md-6 col-sm-12">
                                    <label for="Skills" class="form-label mb-0">Interest</label>
                                    <select id="Interests" name="Interests" class="form-control form-select-sm py-1" multiple="multiple">
                                        <option value="">-- Select Interest --</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                    </div>
                    <div class="row g-1 mt-1">
                        <div class="col-12 mb-1">
                            <label for="DistrictId" class="form-label mb-0">District *</label>
                            <select id="DistrictId" name="DistrictId" class="form-select form-select-sm py-1" required>
                                <option value="">-- Select District --</option>
                                @if (ViewBag.Districts != null)
                                {
                                    @foreach (var district in ViewBag.Districts as IEnumerable<StudentManagement.Models.District>)
                                    {
                                        <option value="@district.Id" selected="@(district.Id == Model?.DistrictId)">@district.Name</option>
                                    }
                                }
                            </select>
                        </div>
                        <div class="col-12 mb-1">
                            <label for="ThanaId" class="form-label mb-0">Thana *</label>
                            <select id="ThanaId" name="ThanaId" class="form-select form-select-sm py-1" required disabled>
                                <option value="">-- Select Thana --</option>
                            </select>
                        </div>
                        <div class="col-12 mb-1">
                            <label for="VillageId" class="form-label mb-0">Village *</label>
                            <select id="VillageId" name="VillageId" class="form-select form-select-sm py-1" required disabled>
                                <option value="">-- Select Village --</option>
                            </select>
                        </div>
                    </div>
                    <div class="row g-1 mt-1">
                        <div class="col-12 mb-1">
                            <label for="JoiningDate" class="form-label mb-0">Joining Date *</label>
                            <input type="date" class="form-control form-control-sm py-1" id="JoiningDate" name="JoiningDate"
                                   value="@(Model?.JoiningDate != default(DateTime) ? Model.JoiningDate.ToString("yyyy-MM-dd") : DateTime.Now.ToString("yyyy-MM-dd"))" required />
                        </div>
                        <div class="col-12 mb-1">
                            <label for="Email" class="form-label mb-0">Email *</label>
                            <input type="email" class="form-control form-control-sm py-1" id="Email" name="Email" value="@(Model?.Email ?? "")" required />
                        </div>
                        <div class="col-12 mb-1">
                            <label for="Phone" class="form-label mb-0">Phone *</label>
                            <input type="tel" class="form-control form-control-sm py-1" id="Phone" name="Phone" value="@(Model?.Phone ?? "")" required />
                        </div>
                    </div>
                    <div class="row g-1 mt-1">
                        <div class="col-6 form-check mb-1">
                            <input type="checkbox" class="form-check-input" id="IsActive" name="IsActive" @(Model?.IsActive == true ? "checked" : "") />
                            <label class="form-check-label" for="IsActive">Is Active</label>
                        </div>
                        <div class="col-6 mb-1">
                            <label for="ImageFile" class="form-label mb-0">Employee Image</label>
                            <input type="file" class="form-control form-control-sm py-1" id="ImageFile" name="ImageFile" accept="image/*" />
                        </div>
                    </div>
                    <div class="d-flex justify-content-between mt-1">
                        <button type="submit" class="btn btn-success btn-sm py-1 addtotable">Add to Table</button>
                        <div>
                            <button type="submit" class="btn btn-primary btn-sm py-1">Create</button>
                            <a asp-action="Index" class="btn btn-secondary btn-sm py-1 ms-1">Cancel</a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        <div class="col-lg-8 col-md-7 col-sm-12">
            <h5 class="text-center mb-1">Employee Temp List</h5>
            <div class="card p-1 border-0" style="font-size: 0.8rem; max-height: 450px; overflow-y: auto;">
                <div class="text-end mb-1">
                    <button type="button" class="btn btn-success btn-sm py-1 addtodb">Add to DB</button>
                </div><br />
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-bordered table-striped table-sm mb-0" id="employeeTable">
                        <thead class="">
                            <tr>
                                <th style="padding:0.2rem;">Image</th>
                                <th style="padding:0.2rem;">Name</th>
                                <th style="padding:0.2rem;">Sex</th>
                                <th style="padding:0.2rem;">Interest</th>
                                <th style="padding:0.2rem;">District</th>
                                <th style="padding:0.2rem;">Thana</th>
                                <th style="padding:0.2rem;">Village</th>
                                <th style="padding:0.2rem;">Joining Date</th>
                                <th style="padding:0.2rem;">Email</th>
                                <th style="padding:0.2rem;">Phone</th>
                                <th style="padding:0.2rem;">Is Active</th>
                                <th style="padding:0.2rem; white-space: nowrap;">Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>


@section Scripts {
    <script type="text/javascript">
        $(document).ready(function () {
            console.log('Page loaded, initializing cascading dropdowns...');

            if ($('#DistrictId').val()) {
                console.log('District has value, enabling Thana dropdown');
                $('#ThanaId').prop('disabled', false);
            }

            if ($('#ThanaId').val()) {
                console.log('Thana has value, enabling Village dropdown');
                $('#VillageId').prop('disabled', false);
            }

        $('#DistrictId, #ThanaId, #VillageId, #Interests').select2({
            placeholder: "-- Select --",
            allowClear: true,
            width: '100%'
        });

        $('#Interests').select2({
                placeholder: "Select interests",
                tags: true,
                allowClear: true,
                ajax: {
                    url: '/Employee/GetInterests',
                    dataType: 'json',
                    delay: 250,
                    processResults: function (data) {
                        return {
                            results: data.map(function (item) {
                                return { id: item.id, text: item.name };
                           
                            })
                        };
                    },
                    cache: true
                }
            });



            $('#DistrictId').change(function () {
                var districtId = $(this).val();
                console.log('Raw DistrictId value:', districtId);
                console.log('DistrictId type:', typeof districtId);
                console.log('Selected option text:', $(this).find('option:selected').text());

                $('#ThanaId').empty().append('<option value="">-- Select Thana --</option>').prop('disabled', true);
                $('#VillageId').empty().append('<option value="">-- Select Village --</option>').prop('disabled', true);

                if (districtId && districtId !== '' && districtId !== '0') {
                    console.log('Making AJAX call with districtId:', districtId);

                    $.ajax({
                        url: '/Employee/GetThanasByDistrict',
                        type: 'GET',
                        data: { districtId: parseInt(districtId) },
                        success: function (data) {
                            console.log('Thanas loaded:', data);
                            var thanaSelect = $('#ThanaId');
                            thanaSelect.empty();
                            thanaSelect.append('<option value="">-- Select Thana --</option>');

                            if (data && data.length > 0) {
                                $.each(data, function (index, thana) {
                                    thanaSelect.append('<option value="' + thana.id + '">' + thana.name + '</option>');
                                });
                                thanaSelect.prop('disabled', false);
                            } else {
                                console.log('No thanas found for this district');
                                alert('No Thanas found for this district.');
                            }
                        },
                        error: function (xhr, status, error) {
                            console.error('Error loading thanas:', error);
                            alert('Failed to load Thanas. Please try again.');
                        }
                    });
                } else {
                    console.log('DistrictId is empty or invalid, not making AJAX call');
                }
        });

            $('#ThanaId').change(function () {
                var thanaId = $(this).val();
                console.log('Raw ThanaId value:', thanaId);
                console.log('ThanaId type:', typeof thanaId);
                console.log('Selected option text:', $(this).find('option:selected').text());

                $('#VillageId').empty().append('<option value="">-- Select Village --</option>').prop('disabled', true);

                if (thanaId && thanaId !== '' && thanaId !== '0') {
                    console.log('Making AJAX call with thanaId:', thanaId);

                    $.ajax({
                        url: '/Employee/GetVillagesByThana',
                        type: 'GET',
                        data: { thanaId: parseInt(thanaId) },
                        success: function (data) {
                            console.log('Villages loaded:', data);

                            var villageSelect = $('#VillageId');
                            villageSelect.empty();
                            villageSelect.append('<option value="">-- Select Village --</option>');

                            if (data && data.length > 0) {
                                $.each(data, function (index, village) {
                                    villageSelect.append('<option value="' + village.id + '">' + village.name + '</option>');
                                });
                                villageSelect.prop('disabled', false);
                            } else {
                                console.log('No villages found for this thana');
                                alert('No Villages found for this thana.');
                            }
                        },
                        error: function (xhr, status, error) {
                            console.error('Error loading villages:', error);
                            alert('Failed to load Villages. Please try again.');
                        }
                    });
                } else {
                    console.log('ThanaId is empty or invalid, not making AJAX call');
                }
            });
            });

        $('.addtotable').click(function (e) {
            e.preventDefault();

            var name = $('#Name').val();
            var sex = $('input[name="Sex"]:checked').val();

            var districtId = $('#DistrictId').val();
            var districtText = $('#DistrictId option:selected').text();
            var thanaId = $('#ThanaId').val();
            var thanaText = $('#ThanaId option:selected').text();
            var villageId = $('#VillageId').val();
            var villageText = $('#VillageId option:selected').text();

            console.log('District ID:', districtId, 'Text:', districtText);
            console.log('Thana ID:', thanaId, 'Text:', thanaText);
            console.log('Village ID:', villageId, 'Text:', villageText);

            var joiningDate = $('#JoiningDate').val();
            var email = $('#Email').val();
            var phone = $('#Phone').val();
            var isActive = $('#IsActive').is(':checked') ? 'Yes' : 'No';
            var imageFile = $('#ImageFile')[0].files[0];
            var interests = $('#Interests option:selected').map(function () {
                return $(this).text();
            }).get().join(', ');

            if (imageFile) {
                var reader = new FileReader();
                reader.onload = function (e) {
                    var imagePreview = `<img src="${e.target.result}" alt="Employee Image" width="50" height="50"/>`;
                    var newRow = $(`<tr>
                        <td>${imagePreview}</td>
                        <td>${name}</td>
                        <td>${sex}</td>
                        <td data-values="${$('#Interests').val()}">${interests}</td>
                        <td data-id="${districtId}">${districtText}</td>
                        <td data-id="${thanaId}">${thanaText}</td>
                        <td data-id="${villageId}">${villageText}</td>
                        <td>${joiningDate}</td>
                        <td>${email}</td>
                        <td>${phone}</td>
                        <td>${isActive}</td>
                        <td class="d-flex gap-1">
                            <button type="button" class="btn btn-sm py-0 px-1 view-btn">View</button><span class="mx-1">|</span>
                            <button type="button" class="btn btn-sm py-0 px-1 edit-btn">Edit</button><span class="mx-1">|</span>
                            <button type="button" class="btn btn-sm py-0 px-1 delete-btn">Delete</button>
                        </td>
                    </tr>`);
                    newRow.data('imageFile', imageFile);
                    newRow.data('interests', interests);

                    $('#employeeTable tbody').append(newRow);
                    $('form')[0].reset();
                    $('#Interests').val(null).trigger('change');
                    $('#DistrictId').val('').trigger('change.select2');
                    $('#ThanaId, #VillageId').prop('disabled', true).empty().append('<option value="">-- Select --</option>');
                }
                reader.readAsDataURL(imageFile);
            } else {
                var newRow = $(`<tr>
                    <td>Empty</td>
                    <td>${name}</td>
                    <td>${sex}</td>
                    <td data-values="${$('#Interests').val()}">${interests}</td>
                    <td data-id="${districtId}">${districtText}</td>
                    <td data-id="${thanaId}">${thanaText}</td>
                    <td data-id="${villageId}">${villageText}</td>
                    <td>${joiningDate}</td>
                    <td>${email}</td>
                    <td>${phone}</td>
                    <td>${isActive}</td>
                    <td>
                        <button type="button" class="btn btn-sm view-btn">View</button>|
                        <button type="button" class="btn btn-sm edit-btn">Edit</button>|
                        <button type="button" class="btn btn-sm delete-btn">Delete</button>
                    </td>
                </tr>`);
                newRow.data('interests', interests);
                $('#employeeTable tbody').append(newRow);

                $('form')[0].reset();
                $('#Interests').val(null).trigger('change');
                $('#DistrictId').val('').trigger('change.select2');
                $('#ThanaId, #VillageId').prop('disabled', true).empty().append('<option value="">-- Select --</option>');
            }
        });



                    $(document).on('click', '.delete-btn', function () {
                            if (confirm('Are you sure you want to delete this employee?')) {
                                $(this).closest('tr').remove();
                            }
                        });

                    $(document).on('click', '.view-btn', function () {
                        var row = $(this).closest('tr');
                        alert(`Employee Details:\n
                            Name: ${row.find('td:eq(0)').text()}
                            Sex: ${row.find('td:eq(1)').text()}
                            District: ${row.find('td:eq(2)').text()}
                            Thana: ${row.find('td:eq(3)').text()}
                            Village: ${row.find('td:eq(4)').text()}
                            Joining Date: ${row.find('td:eq(5)').text()}
                            Email: ${row.find('td:eq(6)').text()}
                            Phone: ${row.find('td:eq(7)').text()}
                            Is Active: ${row.find('td:eq(8)').text()}
                        `);
                    });

        $(document).on('click', '.edit-btn', function () {
            var row = $(this).closest('tr');

            var imgSrc = row.find('td:eq(0) img').attr('src');
            if (imgSrc) {
                $('#PreviewImage').attr('src', imgSrc);
                $('#HiddenImagePath').val(imgSrc);
            }

            $('#Name').val(row.find('td:eq(1)').text());
            $('input[name="Sex"][value="' + row.find('td:eq(2)').text() + '"]').prop('checked', true);

            var interestValues = row.find('td:eq(3)').data('values');
            if (interestValues) {
                var selectedValues = interestValues.toString().split(',');
                console.log(selectedValues);
                $('#Interests').val(selectedValues).trigger('change');
            }

            var districtId = row.find('td:eq(4)').data('id');
            var thanaId = row.find('td:eq(5)').data('id');
            var villageId = row.find('td:eq(6)').data('id');

            console.log('Retrieved District ID:', districtId);
            console.log('Retrieved Thana ID:', thanaId);
            console.log('Retrieved Village ID:', villageId);

            if (districtId) {
                $('#DistrictId').val(districtId).trigger('change');
                setTimeout(function () {
                    console.log('Setting Thana ID:', thanaId);
                    if (thanaId) {
                        $('#ThanaId').val(thanaId).trigger('change');
                        setTimeout(function () {
                            console.log('Setting Village ID:', villageId);
                            if (villageId) {
                                $('#VillageId').val(villageId).trigger('change');
                            }
                        }, 300);
                    }
                }, 300);
            }

            $('#JoiningDate').val(row.find('td:eq(7)').text());
            $('#Email').val(row.find('td:eq(8)').text());
            $('#Phone').val(row.find('td:eq(9)').text());
            $('#IsActive').prop('checked', row.find('td:eq(10)').text() === 'Yes');

            row.remove();
        });




                                  $('.addtodb').click(function(e) {
                                        e.preventDefault();

                                        var tableRows = $('#employeeTable tbody tr');
                                        if (tableRows.length === 0) {
                                            alert('No employees');
                                            return;
                                        }

                                        var $btn = $(this);
                                        $btn.prop('disabled', true).text('Saving...');

                                        var promises = [];

                                        tableRows.each(function() {
                                            var row = $(this);
                                            var formData = new FormData();

                                            formData.append('Name', row.find('td:eq(1)').text());
                                            formData.append('Sex', row.find('td:eq(2)').text());
                                            formData.append('InterestNames', row.find('td:eq(3)').text());
                                            formData.append('DistrictId', row.find('td:eq(4)').data('id'));
                                            formData.append('ThanaId', row.find('td:eq(5)').data('id'));
                                            formData.append('VillageId', row.find('td:eq(6)').data('id'));
                                            formData.append('JoiningDate', row.find('td:eq(7)').text());
                                            formData.append('Email', row.find('td:eq(8)').text());
                                            formData.append('Phone', row.find('td:eq(9)').text());
                                            formData.append('IsActive', row.find('td:eq(10)').text() === 'Yes');

                                            var imageFile = row.data('imageFile');
                                            if (imageFile) {
                                                formData.append('ImageFile', imageFile);
                                            }

                                            var promise = $.ajax({
                                                url: '/Employee/SaveEmployee',
                                                type: 'POST',
                                                data: formData,
                                                processData: false,
                                                contentType: false
                                            });

                                            promises.push(promise);
                                        });

                                        $.when.apply($, promises).done(function() {
                                            alert(`${tableRows.length} employees saved successfully!`);
                                            $('#employeeTable tbody').empty();
                                            $('form')[0].reset();
                                            $('#ThanaId, #VillageId').prop('disabled', true).empty().append('<option value="">-- Select --</option>');
                                            $btn.prop('disabled', false).text('Add to DB');
                                        }).fail(function() {
                                            alert('Some employees failed to save. Please check and try again.');
                                            $btn.prop('disabled', false).text('Add to DB');
                                        });
                                    });



    </script>
}